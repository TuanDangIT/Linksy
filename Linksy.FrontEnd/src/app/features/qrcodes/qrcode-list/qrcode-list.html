<div class="toolbar">
    <button class="toolbar-btn primary" type="button" (click)="openCreateModal()">Create</button>
    <button class="toolbar-btn primary" type="button" (click)="openFilterModal()">Filters</button>
    <button class="toolbar-btn" type="button" (click)="clearFilters()">Clear</button>
</div>

@if (appliedFilters.length > 0) {
<div class="applied-filters">
    @for (f of appliedFilters; track f.key) {
    <span class="filter-chip">
        <strong>{{ f.key }}</strong>: {{ f.value }}
    </span>
    }
</div>
}

@if (qrcodes().length === 0) {
<div class="empty-state">No QR codes found.</div>
} @else {
<div class="table-container">
    <table class="qrcode-table">
        <thead>
            <tr>
                <th (click)="sortBy('Id')" class="sortable">
                    ID<span class="sort-icon">{{ getSortIcon('Id') }}</span>
                </th>
                <th>Url.Code</th>
                <th>Url.OriginalUrl</th>
                <th>UTM Source</th>
                <th>UTM Medium</th>
                <th>UTM Campaign</th>
                <th (click)="sortBy('ScanCount')" class="sortable">
                    ScanCount<span class="sort-icon">{{ getSortIcon('ScanCount') }}</span>
                </th>
                <th>UTM</th>
                <th>Tags</th>
                <th (click)="sortBy('CreatedAt')" class="sortable">
                    CreatedAt<span class="sort-icon">{{ getSortIcon('CreatedAt') }}</span>
                </th>
                <!-- <th>UpdatedAt</th> -->
                <th>Actions</th>
            </tr>
        </thead>

        <tbody>
            @for (qr of qrcodes(); track qr.id) {
            <tr>
                <td class="id-cell"><a class="id-link" [routerLink]="['/qrcodes', qr.id]">{{ qr.id }}</a></td>

                @if(qr.url){
                <td class="code-cell">
                    <div class="code-wrapper">
                        <code>{{ qr.url.code }}</code>
                        <button class="btn-copy" type="button" title="Copy QR code URL"
                            (click)="copyQrCodeUrl(qr, true)">
                            <fa-icon [icon]="faCopy"></fa-icon>
                        </button>
                    </div>
                </td>
                <td class="url-cell">
                    <a [href]="qr.url.originalUrl" target="_blank" rel="noreferrer">
                        {{ qr.url.originalUrl }}
                    </a>
                </td>
                } @else {
                <td class="code-cell">
                    <div class="code-wrapper">
                        <code>{{ qr.umtParameter!.url!.code }}</code>
                        <button class="btn-copy" type="button" (click)="copyQrCodeUrl(qr, false)">
                            <fa-icon [icon]="faCopy"></fa-icon>
                        </button>
                    </div>
                </td>
                <td class="url-cell">
                    <a [href]="qr.umtParameter!.url!.originalUrl" target="_blank" rel="noreferrer">
                        {{ qr.umtParameter!.url!.originalUrl }}
                    </a>
                </td>
                }

                <td class="utm-cell">
                    {{ qr.umtParameter?.umtSource ?? '-' }}
                </td>

                <td class="utm-cell">
                    {{ qr.umtParameter?.umtMedium ?? '-' }}
                </td>

                <td class="utm-cell">
                    {{ qr.umtParameter?.umtCampaign ?? '-' }}
                </td>

                <td class="visits-cell">
                    <span class="visits-badge">{{ qr.scanCount }}</span>
                </td>

                <td class="flag-cell">
                    <span class="flag-badge" [class.flag-true]="!!qr.umtParameter"
                        [class.flag-false]="!qr.umtParameter">
                        {{ qr.umtParameter ? 'True' : 'False' }}
                    </span>
                </td>

                <td class="tags-cell">
                    @if (qr.tags && qr.tags.length > 0) {
                    <div class="tags">
                        @for (tag of qr.tags; track tag) {
                        <span class="tag">{{ tag }}</span>
                        }
                    </div>
                    } @else {
                    <span>-</span>
                    }
                </td>

                <td class="date-cell">{{ formatDate(qr.createdAt) }}</td>

                <!-- <td class="date-cell">
                    @if (qr.updatedAt) {
                    {{ formatDate(qr.updatedAt) }}
                    } @else {
                    <span>-</span>
                    }
                </td> -->

                <td class="actions-cell">
                    <button type="button" class="action-btn" title="QrCode details" (click)="openDetails(qr.id)">
                        <fa-icon [icon]="faEye"></fa-icon>
                    </button>

                    <button type="button" class="action-btn" title="Download QrCode" (click)="download(qr.id)">
                        <fa-icon [icon]="faDownload"></fa-icon>
                    </button>

                    <button type="button" class="action-btn danger" title="Delete QrCode" (click)="openDeleteConfirm(qr)">
                        <fa-icon [icon]="faTrash"></fa-icon>
                    </button>
                </td>
            </tr>
            }
        </tbody>
    </table>
</div>

<div class="pagination-container">
    <div class="pagination-info">
        Showing {{ rangeStart() }}-{{ rangeEnd() }} of {{ totalCount() }}
    </div>

    <div class="pagination-controls">
        <label class="page-size">
            Rows:
            <select [value]="pageSize()" (change)="setPageSize(($any($event.target)).value)">
                @for (size of pageSizeOptions; track size) {
                <option [value]="size">{{ size }}</option>
                }
            </select>
        </label>

        <button class="page-btn" type="button" (click)="prevPage()" [disabled]="!canGoPrev()">Prev</button>

        @for (page of pageNumbers; track page) {
        <button class="page-btn" type="button" [class.active]="page === currentPage()" (click)="goToPage(page)">
            {{ page }}
        </button>
        }

        <button class="page-btn" type="button" (click)="nextPage()" [disabled]="!canGoNext()">Next</button>
    </div>
</div>
}

<app-filter-modal [isOpen]="isFilterModalOpen()" [availableFilters]="availableFilters" (cancel)="closeFilterModal()"
    (apply)="applyFilters($event)">
</app-filter-modal>

<app-confirm-modal [isOpen]="confirmOpen()" [title]="confirmTitle()" [message]="confirmMessage()"
    [confirmText]="confirmConfirmText()" [confirmVariant]="confirmVariant()" (cancel)="closeConfirm()"
    (confirm)="confirmDelete()">
</app-confirm-modal>

<app-create-qrcode-modal [isOpen]="isCreateModalOpen()" (cancel)="closeCreateModal()" (created)="onQrCreated()">
</app-create-qrcode-modal>